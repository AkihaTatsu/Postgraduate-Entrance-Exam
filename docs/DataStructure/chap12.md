# 文件

## 有关文件的基本概念

+ **文件**（file）是由**大量性质相同的记录**组成的集合。可按其**记录的类型不同**而分成两类：
  + **操作系统中的文件**：仅是一维的**连续的字符序列**，无结构、无解释
    + 它也是**记录的集合**，这个**记录仅是一个字符组**，用户为了存取、加工方便，把文件中的信息划分成若干组，每一组信息称为一个逻辑记录，且可按顺序编号
  + **数据库中的文件**：是**带有结构的记录的集合**
    + 这类**记录**是由**一个或多个数据项组成的集合**，它也是文件中**可存取的数据**的**基本单位**
      + **数据项**是最**基本的不可分的数据单位**，也是**文件中可使用的数据**的**最小单位**
    + 数据库文件还可按**记录中关键字的多少**分成单关键字文件和多关键字文件：
      + 若文件中的记录只有一个**惟一标识记录的主关键字**，则称**单关键字文件**
      + 若文件中的记录除了含有一个主关键字外，还含有**若干个次关键字**，则称为**多关键字文件**，记录中所有**非关键字的数据项**称为记录的**属性**
+ 文件还可按记录的另一特性分成定长记录文件和不定长记录文件
  + 若文件中**每个记录含有的信息长度相同**，则称这类记录为**定长记录**，由这类记录组成的文件称做**定长记录文件**
  + 若文件中含有**信息长度不等**的**不定长记录**，则称**不定长记录文件**
+ 记录的**逻辑结构**和**物理结构**：
  + 记录的**逻辑结构**是指记录在用户或应用程序员面前呈现的方式，是用户对数据的表示和存取方式
    + 记录的逻辑结构通常着眼在**用户使用方便**
  + 记录的**物理结构**是数据在物理存储器上存储的方式，是数据的物理表示和组织
    + 记录的物理结构则应考虑**提高存储空间的利用率**和**减少存取记录的时间**，它根据不同的需要及设备本身的特性可以有多种方式
  + 在物理记录和逻辑记录之间可能存在下列3种关系：
    + **一个物理记录**存放**一个逻辑记录**
    + **一个物理记录**包含**多个逻辑记录**
    + **多个物理记录**表示**一个逻辑记录**
+ 文件的**检索**有下列3种方式：
  + **顺序存取**：存取**下一个逻辑记录**
  + **直接存取**：存取**第$i$个逻辑记录**
    + 以上两种存取方式都是根据**记录序号**（即**记录存入文件时的顺序编号**）或**记录的相对位置**进行存取的
  + **按关键字存取**：**给定一个值**，查询**一个或一批关键字与给定值相关**的**记录**
    + 对数据库文件可以有如下4种查询方式：
      + **简单询问**：查询**关键字等于给定值**的记录
      + **区域询问**：查询**关键字属某个区域内**的记录
      + **函数询问**：给定**关键字**的**某个函数**
      + **布尔询问**：**以上3种询问用布尔运算组合起来**的询问
+ 文件的**物理结构**：文件在**存储介质**（磁盘或磁带）上的**组织方式**
  + 其基本方式有3种：**顺序组织**、**随机组织**和**链组织**

## 顺序文件

+ **顺序文件**（Sequential File）是记录**按其在文件中的逻辑顺序依次进入存储介质**而建立的，即顺序文件中**物理记录的顺序**和**逻辑记录的顺序**是**一致**的
  + 若**次序相继的两个物理记录**在**存储介质上的存储位置是相邻**的，则又称**连续文件**
  + 若**物理记录之间的次序**由**指针相链**表示，则称**串联文件**
+ 顺序文件是根据**记录的序号**或**记录的相对位置**来进行**存取**的文件组织方式；它的特点是：
  + 存取**第$i$个记录**，必须先**搜索在它之前的$i - 1$个记录**
  + **插入新的记录**时**只能加在文件的末尾**
  + 若要**更新文件中的某个记录**，则必**须将整个文件进行复制**
+ 由于顺序文件的**优点**是**连续存取的速度快**，因此主要用于只进行**顺序存取、批量修改**的情况；若对**应答时间要求不严**时亦可进行**直接存取**
+ **磁带**是一种典型的**顺序存取设备**，因此存储在磁带上的文件只能是顺序文件；磁带文件适合于文件的**数据量甚大**、**平时记录变化少**、**只作批量修改**的情况
  + 磁带文件的**批处理过程**：
    1. 前期准备：
       + **待修改的原始文件**称做**主文件**，存放在**一条磁带**上
       + **所有的修改请求**集中构成一个文件，称做**事务文件**，存放在**另一台磁带**上
       + 尚需**第三台磁带**作为**新的主文件的存储介质**
    2. **主文件**按**关键字自小至大**（或**自大至小**）**顺序有序**，**事务文件**必须**和主文件有相同的有序关系**
    3. 首先对**事务文件**进行**排序**，然后将**主文件**和**事务文件**都**归并成一个新的主文件**
       + 在归并的过程中，**顺序读出主文件与事务文件中的记录**，**比较它们的关键字**并分别进行**处理**
         + 对于**关键字不匹配的主文件中的记录**，则**直接将其写入新主文件中**
         + **“更改”** 和 **“删去”** 记录时，要求其**关键字相匹配**
           + **“删去”不用写入**，而 **“更改”** 则要将**更改后的新记录写入新主文件**
         + **“插入”** 时**不要求关键字相匹配**，可直接将事务文件上要插入的记录**写到新主文件的适当位置**
  + 分析批处理算法的时间：假设主文件包含$n$个记录，事务文件包含$m$个记录
    + 一般情况下，事务文件较小，可以进行**内部排序**，其**时间复杂度**为$O(m \log m)$
    + **内部归并**的**时间复杂度**为$O(n + m)$
    + 总的**内部处理的时间**为$O(m \log m + n)$
  + 假设所有的输入 / 输出都是通过缓冲区进行的，并假设缓冲区大小为s（个记录），则整个批处理过程中**读 / 写外存的次数**为$2 \left\lceil \frac{m}{s} \right\rceil + 2\left\lceil \frac{m + n}{s} \right\rceil$

## 索引文件

+ **索引表**：指示**逻辑记录**和**物理记录**之间**一一对应关系**的表
  + 索引表中的**每项**称做**索引项**
  + 不论主文件是否按关键字有序，索引表中的**索引项总是按关键字**（或**逻辑记录号**）**顺序排列**
+ **索引文件**：包括**文件数据区**和**索引表**两大部分的**文件**
  + 若**数据区中的记录**也**按关键字顺序排列**，则称**索引顺序文件**
  + 反之，若**数据区中记录不按关键字顺序排列**，则称**索引非顺序文件**
+ 索引表是由**系统程序自动生成**的；在**记录输入建立数据区**的**同时建立一个索引表**，表中的**索引项按记录输入的先后次序排列**，待**全部记录输入完毕**后再**对索引表进行排序**
+ 索引文件的**检索方式**为**直接存取**或**按关键字**（进行**简单询问**）**存取**，检索过程如下：
  1. **查找索引表**
     + 若索引表上**不存在该记录**，则说明**外存上不存在该记录**，也就**不需要访问外存**
  2. 若索引表上**存在该记录**，则根据索引项的指示读取外存上该记录
+ 索引文件的**修改**：
  + **删除**一个记录时，仅需**删去相应的索引项**
  + **插入**一个记录时，应将**记录置于数据区的末尾**，同时**在索引表中插入索引项**
  + **更新**记录时，应将**更新后的记录置于数据区的末尾**，同时**修改索引表中相应的索引项**
+ 当记录数目很大时，索引表也很大，以致一个物理块容纳不下；在这种情况下，可以**对索引表建立一个索引**，称为**查找表**
  + **检索**记录时，先**查找查找表**，再**查找索引表**，然后**读取记录**，总计**3次访问外存**
  + 若查找表中项目还多，则可建立更高一级的索引；通常**最高可有四级索引**
+ 当**数据文件**在使用过程中**记录变动较多**时，应采用**动态索引**，例如：**二叉排序树**（或**二叉平衡树**）、**B-树**以及**键树**等树表结构
  + 由于**其本身是层次结构**，则**无需建立多级索引**，而且**建立索引表的过程**即**排序的过程**
+ **索引文件只能是磁盘文件**
+ 由于**数据文件中记录不按关键字顺序排列**，则**必须对每个记录建立一个索引项**，如此建立的**索引表**称之为**稠密索引**
  + 其特点是**可以在索引表中进行“预查找”**，即从**索引表**便可**确定待查记录是否存在**或**作某些逻辑运算**
+ 如果**数据文件中的记录按关键字顺序有序**，则可**对一组记录建立一个索引项**，这种索引表称之为**非稠密索引**
  + 它**不能进行“预查找”**，但**索引表占用的存储空间少**，管理要求低

## ISAM文件和VSAM文件

### ISAM文件

+ **索引顺序存取方法ISAM**为Indexed Sequential Access Methed的缩写，它是一种专为**磁盘存取**设计的文件组织方式
  + 由于磁盘是以**盘组**，**柱面**和**磁道**三级地址存取的设备，则可分别对磁盘上的数据文件建立盘组、柱面和磁道**三级索引**
    + 文件的记录在同一盘组上存放时，应先**集中放在一个柱面**上，然后再**顺序存放在相邻的柱面**上；对**同一柱面**，则应**按盘面的次序**顺序存放
    + **每个柱面**建立一个**磁道索引**，每个**磁道索引项**由两部分组成：**基本索引项**和**溢出索引项**
      + 每一部分都包括**关键字**和**指针**两项，**关键字**表示**该磁道中最末一个记录的关键字**（在此为**最大关键字**），**指针**指示该磁道中**第一个记录的位置**
    + **柱面索引**的每一个**索引项**也由**关键字**和**指针**两部分组成，**关键字**表示**该柱面中最末一个记录的关键字**（**最大关键字**），**指针**指示该柱面上的**磁道索引位置**
      + 柱面索引存放在某个柱面上，若**柱面索引较大，占多个磁道**时，则可建立**柱面索引的索引**——**主索引**
+ 在ISAM文件上检索记录时：
  1. 先从**主索引**出发找到相应的**柱面索引**
  2. 再从**柱面索引**找到**记录所在柱面的磁道索引**
  3. 最后从**磁道索引**找到**记录所在磁道的第一个记录的位置**
  4. 由此出发**在该磁道上进行顺序查找**直至**找到为止**；反之，若**找遍该磁道而不存在此记录**，则表明该文件中**无此记录**
+ 每个**柱面**上还开辟有一个**溢出区**，并且，**磁道索引项**中有**溢出索引项**，这是为**插入记录**所设置的：
  + 由于**ISAM文件中记录**是按**关键字顺序**存放的，则在**插入记录**时需**移动记录**，并将**同一磁道上最末一个记录移至溢出区**，同时**修改磁道索引项**
  + 通常溢出区可有3种设置方法：
    + **集中存放**：**整个文件**设一个**大的单一的溢出区**
    + **分散存放**：**每个柱面设一个溢出区**
    + **集中与分散相结合**：溢出时记录先**移至每个柱面各自的溢出区**，待**满之后**再**使用公共溢出区**
  + 每个**柱面**的**基本区**是**顺序存储结构**，而**溢出区**是**链表结构**

### VSAM文件

+ **虚拟存储存取方法VSAM**是Virtual Storage Access Method的缩写；这种存取方法利用了**操作系统的虚拟存储器**的功能，给用户提供方便
  + 对用户来说，文件只有**控制区间**和**控制区域**等**逻辑存储单位**，与外存储器中柱面、磁道等**具体存储单位**是**没有必然的联系**的
  + 用户在存取文件中的记录时，**不需要考虑这个记录的当前位置是否在内存**，也**不需要考虑何时执行对外存进行“读 / 写”的指令**
+ VSAM文件的**结构**由3部分组成：**索引集**、**顺序集**和**数据集**
  + **文件的记录**均存放在**数据集**中，**数据集**中的一个**结点**称为**控制区间**（Control Interval）
    + 它是一个**I / O操作的基本单位**，由**一组连续的存储单元组成**
    + **控制区间的大小**可随**文件不同而不同**，但**同一文件**上**控制区间的大小相同**
    + **每个控制区间**含有**一个或多个按关键字递增有序排列的记录**
  + **顺序集**和**索引集**一起**构成一棵B+树**，为文件的**索引部分**
    + **顺序集**中存放**每个控制区间的索引项**
      + 每个控制区间的索引项由两部分信息组成，即**该控制区间中的最大关键字**和**指向控制区间的指针**
    + **若干相邻控制区间的索引项**形成**顺序集中的一个结点**，**结点之间用指针相链结**，而**每个结点又在其上一层的结点中建有索引**，且**逐层向上建立索引**
      + 所有的**索引项**都由**最大关键字**和**指针**两部分信息组成，这些**高层的索引项**形成**B+树的非终端结点**
  + 因此，VSAM文件既可**在顺序集中进行顺序存取**，又可**从最高层的索引**（**B+树的根结点**）出发进行**按关键字存取**
  + **顺序集**中**一个结点连同其对应的所有控制区间形成一个整体**，称做**控制区域**（Control Range）
    + **每个控制区间**可视为一个**逻辑磁道**，而**每个控制区域**可视为一个**逻辑柱面**
+ 在VSAM文件中，**记录可以是不定长**的，则在**控制区间**中除了存放**记录本身**以外，还有**每个记录的控制信息**（如**记录的长度**等）和**整个区间的控制信息**（如**区间中存有的记录数**等）
  + 在**控制区间**上**存取一个记录**时需**从控制区间的两端出发同时向中间扫描**
+ VSAM文件中**没有溢出区**，解决插入的办法是**在初建文件时留有空间**：
  + 方法一：每个控制区间内**不填满记录**，在**最末一个记录**和**控制信息**之间留有**空隙**
  + 方法二：在**每个控制区域**中有一些**完全空的控制区间**，并**在顺序集的索引中指明这些空区间**
+ VSAM文件的
  + **缺点**：
    + **占有较多的存储空间**，一般只能保持约75%的存储空间利用率
  + **优点**：
    + **动态地分配和释放存储空间**，**不需要对文件进行重组**
    + 能**较快地对插入的记录进行查找**，**查找一个后插入记录的时间**与**查找一个原有记录的时间**是**相同**的

## 直接存取文件（散列文件）

+ **直接存取文件**指的是利用**散列**（Hash）**法**进行组织的文件
  + 它**类似于哈希表**，即根据文件中关键字的特点设计一种**哈希函数**和**处理冲突的方法**将记录散列到存储设备上，故又称散列文件
  + 与**哈希表不同**的是，对于文件来说，磁盘上的文件记录通常是**成组存放的**，**若干个记录组成一个存储单位**，在**散列文件**中，这个**存储单位**叫做**桶**（Bucket）
    + 假若**一个桶能存放$m$个记录**，则 **$m$个同义词的记录可以存放在同一地址的桶**中，而当**第$m + 1$个同义词出现**时**才发生“溢出”**
      + **处理溢出**也可采用哈希表处理冲突的各种方法，但**对散列文件**，主要采用**链地址法**
    + 当**发生“溢出”** 时，需要将**第$m + 1$个同义词**存放到**另一个桶**中，通常称此桶为 **“溢出桶”**；相对地，称**前$m$个同义词存放的桶**为 **“基桶”**
      + **溢出桶**和**基桶大小相同**，**相互之间用指针相链接**
      + 当在**基桶中没有找到待查记录**时，就**顺指针所指到溢出桶中进行查找**；因此，希望同一散列地址的溢出桶和基桶在磁盘上的**物理位置不要相距太远**，**最好在同一柱面上**
+ 总之，直接存取文件的
  + **优点**：
    + **文件随机存放**，**记录不需进行排序**
    + **插入、删除方便**，**存取速度快**，**不需要索引区**，节省存储空间
  + 缺点：
    + **不能进行顺序存取**，只能按关键字随机存取，且**询问方式限于简单询问**
    + 在**经过多次的插入、删除之后**，也可能造成**文件结构不合理**，即**溢出桶满**而**基桶内多数为被删除的记录**；此时亦需**重组文件**

## 多关键字文件

+ 多关键字文件的特点是，在对文件进行检索操作时，不仅对**主关键字**进行**简单询问**，还经常需要对**次关键字**进行**其他类型的询问检索**
  + 对多关键字文件，除了按以上几节讨论的方法**组织文件**之外，尚需**建立一系列的次关键字索引**
    + **次关键字索引**可以是**稠密**的，也可以是**非稠密**的；**索引表**可以是**顺序表**，也可以是**树表**
    + 和主关键字索引表不同，每个**索引项**应**包含**：**次关键字**、**具有同一次关键字的多个记录的主关键字或物理记录号**

### 多重表文件

+ **多重表文件**（Multilist File）的**特点**是：
  + **记录**按**主关键字的顺序**构成一个**串联文件**，并建立**主关键字的索引**（称为**主索引**）
  + 对**每一个次关键字项**建立**次关键字索引**（称为**次索引**），所有**具有同一次关键字的记录**构成一个**链表**
  + **主索引**为**非稠密索引**，**次索引**为**稠密索引**
  + 每个**索引项**包括**次关键字**、**头指针**和**链表长度**
+ 多重链表文件**易于构造**，也**易于修改**
  + 如果**不要求保持链表的某种次序**，则**插入一个新记录**是**容易**的，此时可将**记录插在链表的头指针之后**
  + 但是，要**删去一个记录**却很**繁琐**，需**在每个次关键字的链表**中**删去该记录**

### 倒排文件

+ 倒排文件和多重表文件的区别在于**次关键字索引的结构不同**
  + 通常，称**倒排文件**中的**次关键字索引**为**倒排表**；**具有相同次关键字的记录**之间**不设指针相链**，而在**倒排表**中**该次关键字的一项**中**存放这些记录的物理记录号**
+ 在**插入**和**删除**记录时，倒排表也要作相应的修改，值得注意的是**倒排表**中**具有同一次关键字的记录号**是**有序排列**的，则**修改**时要**作相应移动**
+ 若**数据文件非串链文件**，而是**索引顺序文件**（如ISAM文件），则倒排表中应存放**记录的主关键字**而**不是**~~物理记录号~~
+ 倒排表作索引的
  + **优点**：
    + **检索记录较快**；特别是对**某些询问，不用读取记录**，就可得到解答
  + **缺点**：
    + **维护困难**；在**同一索引表**中，**不同的关键字其记录数不同**，各**倒排表的长度不等**，**同一倒排表中各项长度也不等**